<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>表計算関数シミュレーター</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f4f8; color: #333; font-size: 14px;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .container {
            background-color: #ffffff; padding: 25px; border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); width: 90%; max-width: 800px;
        }
        h1 { color: #2c3e50; text-align: center; margin-top: 0; }
        /* ▼▼▼【変更点1】説明文用のスタイルを追加 ▼▼▼ */
        p.intro {
            text-align: center;
            font-size: 1.1em;
            max-width: 600px;
            margin: 0 auto 25px auto;
            line-height: 1.7;
        }
        
        .controls {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            margin-bottom: 20px; background-color: #fafafa; padding: 15px; border-radius: 8px;
        }
        .control-group label { display: block; font-weight: 500; margin-bottom: 8px; }
        .control-group select, .control-group input {
            width: 100%; padding: 8px; font-size: 1em; border: 1px solid #ccc;
            border-radius: 5px; box-sizing: border-box;
        }
        #formula-bar {
            grid-column: 1 / -1; display: flex; align-items: center; gap: 5px;
            background-color: #e0e0e0; padding: 5px; border-radius: 5px;
        }
        #formula-bar input { background-color: white; flex-grow: 1; }
        
        #spreadsheet { border-collapse: collapse; width: 100%; }
        #spreadsheet th, #spreadsheet td {
            border: 1px solid #ccc; padding: 8px; text-align: center;
            min-width: 60px; height: 30px;
        }
        #spreadsheet th { background-color: #f2f2f2; font-weight: bold; }
        #spreadsheet td { background-color: #fff; cursor: pointer; }
        #spreadsheet td.selected { background-color: #dbeeff; border-color: #3498db; }
        #spreadsheet td.result-cell { background-color: #fff2c4; font-weight: bold; cursor: not-allowed; }

        #explanation-area {
            margin-top: 20px; padding: 15px; background-color: #ecf0f1;
            border-radius: 8px; min-height: 40px; font-size: 1.1em; line-height: 1.6;
        }

        .return-button, .return {
            position: fixed; bottom: 20px; padding: 12px 25px;
            background-color: #5a6268; color: #fff; text-decoration: none;
            border-radius: 50px; font-weight: bold; z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        .return-button { right: 20px; }
        .return { left:15px; }
        .return-button:hover, .return:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            background-color: #494e53;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>表計算関数シミュレーター</h1>
    <p class="intro">
        ドロップダウンから使いたい関数を選び、下の表のセルをクリックして計算したい範囲を選択してください。
        数式バーと結果のセルに、計算結果がリアルタイムで表示されます。
    </p>
    <div class="controls">
        <div class="control-group">
            <label for="function-select">1. 関数を選ぶ</label>
            <select id="function-select">
                <option value="SUM">SUM (合計)</option>
                <option value="AVERAGE">AVERAGE (平均)</option>
                <option value="COUNT">COUNT (数値の個数)</option>
                <option value="IF">IF (もし～なら)</option>
                <option value="COUNTIF">COUNTIF (条件に合う個数)</option>
            </select>
        </div>
        <div class="control-group">
            <label>2. 計算範囲を選ぶ (表をクリック)</label>
            <div id="formula-bar">
                <b id="result-cell-label">B6</b><span>=</span>
                <input type="text" id="formula-input" readonly>
            </div>
        </div>
        <div class="control-group" id="if-controls" style="display: none;">
            <label for="if-condition">3. 条件の数値を入力 (もしB列が > )</label>
            <input type="number" id="if-condition" value="80">
        </div>
    </div>
    <table id="spreadsheet"></table>
    <div id="explanation-area"></div>

    <a href="/word/word5/word5_26.html" class="return">説明ページへ戻る</a>
    <a href="/chapter5.html" class="return-button">章の目次へ戻る</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // JavaScript部分は変更ありません
    const spreadsheet = document.getElementById('spreadsheet');
    const functionSelect = document.getElementById('function-select');
    const formulaInput = document.getElementById('formula-input');
    const resultCellLabel = document.getElementById('result-cell-label');
    const explanationArea = document.getElementById('explanation-area');
    const ifControls = document.getElementById('if-controls');
    const ifCondition = document.getElementById('if-condition');

    const data = [
        ['教科', '点数'],
        ['国語', 85],
        ['数学', 92],
        ['理科', 78],
        ['社会', 88]
    ];
    let selectedRange = { start: null, end: null };
    let isSelecting = false;
    const resultCell = { row: 5, col: 1 };

    const explanations = {
        'SUM': '指定された範囲にある数値の合計を計算します。',
        'AVERAGE': '指定された範囲にある数値の平均値を計算します。',
        'COUNT': '指定された範囲に「数値」がいくつあるかを数えます。',
        'IF': '各セルが指定した条件を満たすか調べ、満たすなら「合格」、そうでなければ「不合格」と表示します。(結果は下にまとめて表示)',
        'COUNTIF': '指定された範囲の中で、条件を満たすセルがいくつあるかを数えます。'
    };

    function createSheet() {
        spreadsheet.innerHTML = '';
        const headers = ['', 'A', 'B'];
        const headerRow = document.createElement('tr');
        headers.forEach(h => {
            const th = document.createElement('th');
            th.textContent = h;
            headerRow.appendChild(th);
        });
        spreadsheet.appendChild(headerRow);
        for (let i = 0; i < data.length; i++) {
            const row = document.createElement('tr');
            const th = document.createElement('th');
            th.textContent = i + 1;
            row.appendChild(th);
            for (let j = 0; j < data[i].length; j++) {
                const td = document.createElement('td');
                td.textContent = data[i][j];
                td.dataset.row = i;
                td.dataset.col = j;
                row.appendChild(td);
            }
            spreadsheet.appendChild(row);
        }
        const resultTr = document.createElement('tr');
        const resultTh = document.createElement('th');
        resultTh.textContent = resultCell.row + 1;
        resultTr.appendChild(resultTh);
        resultTr.appendChild(document.createElement('td'));
        const resultTd = document.createElement('td');
        resultTd.classList.add('result-cell');
        resultTd.id = 'result-cell-td';
        resultTd.dataset.row = resultCell.row;
        resultTd.dataset.col = resultCell.col;
        resultTr.appendChild(resultTd);
        spreadsheet.appendChild(resultTr);
    }
    
    function handleCellClick(e) {
        if (!e.target.matches('td') || e.target.id === 'result-cell-td') return;
        
        const cell = e.target;
        const row = parseInt(cell.dataset.row, 10);
        const col = parseInt(cell.dataset.col, 10);

        if (cell.classList.contains('selected')) {
            selectedRange = { start: null, end: null };
            isSelecting = false;
            updateSelectionAndCalculate();
            return;
        }

        if (!isSelecting) {
            selectedRange.start = { row, col };
            selectedRange.end = { row, col };
            isSelecting = true;
        } else {
            selectedRange.end = { row, col };
            isSelecting = false;
        }
        updateSelectionAndCalculate();
    }
    
    function updateSelectionAndCalculate() {
        document.querySelectorAll('td').forEach(td => td.classList.remove('selected'));
        
        if (selectedRange.start) {
            const startRow = Math.min(selectedRange.start.row, selectedRange.end.row);
            const endRow = Math.max(selectedRange.start.row, selectedRange.end.row);
            const startCol = Math.min(selectedRange.start.col, selectedRange.end.col);
            const endCol = Math.max(selectedRange.start.col, selectedRange.end.col);

            for (let i = startRow; i <= endRow; i++) {
                for (let j = startCol; j <= endCol; j++) {
                    const cell = document.querySelector(`[data-row="${i}"][data-col="${j}"]`);
                    if(cell) cell.classList.add('selected');
                }
            }
        }
        
        calculate();
    }

    function calculate() {
        const func = functionSelect.value;
        const resultTd = document.getElementById('result-cell-td');
        let formula = '';
        let result = '';
        
        let rangeText = '';
        if(selectedRange.start) {
            const startCol = Math.min(selectedRange.start.col, selectedRange.end.col);
            const startRow = Math.min(selectedRange.start.row, selectedRange.end.row);
            const endCol = Math.max(selectedRange.start.col, selectedRange.end.col);
            const endRow = Math.max(selectedRange.start.row, selectedRange.end.row);
            const startCellName = `${String.fromCharCode(65 + startCol)}${startRow + 1}`;
            const endCellName = `${String.fromCharCode(65 + endCol)}${endRow + 1}`;
            rangeText = startCellName === endCellName ? startCellName : `${startCellName}:${endCellName}`;
        }
        
        const rangeData = getRangeData();
        const condition = parseFloat(ifCondition.value);

        switch(func) {
            case 'SUM':
                result = rangeData.reduce((sum, val) => sum + val, 0);
                formula = `SUM(${rangeText || ''})`;
                break;
            case 'AVERAGE':
                const sum = rangeData.reduce((s, v) => s + v, 0);
                result = rangeData.length > 0 ? (sum / rangeData.length).toFixed(1) : 0;
                formula = `AVERAGE(${rangeText || ''})`;
                break;
            case 'COUNT':
                result = rangeData.length;
                formula = `COUNT(${rangeText || ''})`;
                break;
            case 'IF':
                const ifResults = rangeData.map(val => val > condition ? '合格' : '不合格').join(', ');
                result = rangeData.length > 0 ? `結果: ${ifResults}` : '';
                formula = `IF(${rangeText || 'B2:B5'}>${condition}, "合格", "不合格")`;
                break;
            case 'COUNTIF':
                result = rangeData.filter(val => val > condition).length;
                formula = `COUNTIF(${rangeText || ''}, ">${condition}")`;
                break;
        }

        formulaInput.value = formula;
        resultTd.textContent = result;
        explanationArea.textContent = explanations[func];
        ifControls.style.display = (func === 'IF' || func === 'COUNTIF') ? 'block' : 'none';
    }

    function getRangeData() {
        if (!selectedRange.start) return [];
        const values = [];
        const startRow = Math.min(selectedRange.start.row, selectedRange.end.row);
        const endRow = Math.max(selectedRange.start.row, selectedRange.end.row);
        const startCol = Math.min(selectedRange.start.col, selectedRange.end.col);
        const endCol = Math.max(selectedRange.start.col, selectedRange.end.col);
        
        for(let i = startRow; i <= endRow; i++) {
            for(let j = startCol; j <= endCol; j++) {
                if(data[i] && !isNaN(parseFloat(data[i][j]))) {
                    values.push(parseFloat(data[i][j]));
                }
            }
        }
        return values;
    }

    createSheet();
    selectedRange = { start: { row: 1, col: 1 }, end: { row: 4, col: 1 } };
    isSelecting = false;
    updateSelectionAndCalculate();

    spreadsheet.addEventListener('click', handleCellClick);
    functionSelect.addEventListener('change', () => updateSelectionAndCalculate());
    ifCondition.addEventListener('input', () => updateSelectionAndCalculate());
});
</script>
</body>
</html>